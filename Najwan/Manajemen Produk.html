<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manajemen Produk</title>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" />

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Esteban&family=Noto+Sans:wght@400;800&display=swap"
    rel="stylesheet" />

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" />

  <!-- DataTables Bootstrap 5 CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/2.3.0/css/dataTables.bootstrap5.min.css" />

  <style>
    .nav_website {
      background-color: black;
      padding: 2%;
      margin-bottom: 5vh;
    }

    .nav_website a {
      font-family: 'Inter';
      font-weight: 600;
      font-size: 18px;
      color: white;
      padding: 8px 15px;
      border-radius: 5px;
    }

    .nav_website a:hover {
      background-color: white;
      color: black;
      transition: 0.3s;
    }

    .Judul {
      padding: 4%;
      font-family: 'Inter';
      font-weight: 600;
      font-size: 20px;
    }

    .filter_bar {
      position: relative;
    }

    .sort1 {
      padding-left: 4%;
    }

    .sort2 {
      padding-left: 4%;
      opacity: 0;
    }

    .tombol_modif {
      position: absolute;
      right: 4%;
      top: 0;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .tombol1 {
      display: flex;
      align-items: center;
      gap: 8px;
      background-color: #db1515;
    }

    .tombol1:hover {
      background-color: #ff0000;
    }

    .tombol2 {
      display: flex;
      align-items: center;
      gap: 8px;
      background-color: #000000;
    }

    .tabel1 {
      padding: 0 4%;
      margin-bottom: 20vh;
    }

    .kolom th {
      background-color: #D9D9D9;
      border-right: 1px solid black;
      text-align: center;
    }

    tbody {
      text-align: center;
    }

    table.dataTable thead th {
      background-color: #D9D9D9 !important;
      color: black;
      vertical-align: middle;
    }

    table.dataTable thead th.sorting::after,
    table.dataTable thead th.sorting_asc::after,
    table.dataTable thead th.sorting_desc::after {
      color: black !important;
      opacity: 1 !important;
    }

    table.dataTable thead th.sorting::after {
      content: "\f0dc";
      font-family: "Font Awesome 6 Free";
      font-weight: 900;
    }

    table.dataTable thead th.sorting_asc::after {
      content: "\f0de";
      font-family: "Font Awesome 6 Free";
      font-weight: 900;
    }

    table.dataTable thead th.sorting_desc::after {
      content: "\f0dd";
      font-family: "Font Awesome 6 Free";
      font-weight: 900;
    }

  </style>
</head>

<body>

  <!-- Navigation -->
  <nav class="nav_website">
    <ul class="nav nav-pills nav-fill">
      <li class="nav-item"><a class="nav-link" href="proteksiDashboard.php">Dashboard</a></li>
      <li class="nav-item"><a class="nav-link" href="proteksiMP.php">Manajemen Produk</a></li>
      <li class="nav-item"><a class="nav-link" href="proteksiMT.php">Manajemen Transaksi</a></li>
      <li class="nav-item"><a class="nav-link" href="proteksiLaporan.php">Laporan</a></li>
      <li class="nav-item"><a class="nav-link" href="#" id="logoutBtn">Log Out</a></li>
    </ul>
  </nav>

  <!-- Judul -->
  <section class="Judul">
    <p>Modifikasi Produk <br> (Produk Modification)</p>
  </section>

  <!-- Filter Bar -->
  <section class="filter_bar">
    <div class="d-flex justify-content-between align-items-start mb-3">
      <div class="sort1">
        <select class="form-select" id="sortAll" style="width: auto;">
          <option value="">All</option>
          <option value="<10">Kurang dari 10</option>
          <option value="11-50">11-50</option>
          <option value="51-100">51-100</option>
          <option value=">100">Lebih dari 100</option>
        </select>
      </div>
      <div class="tombol_modif">
        <button class="tombol1 btn btn-dark"><span>Delete All</span><i class="fa-solid fa-trash"></i></button>
        <button class="tombol2 btn btn-dark"><span>Add Data</span><i class="fa-solid fa-square-plus"></i></button>
      </div>
    </div>
  </section>

  <!-- Tabel Produk -->
  <section class="tabel1">
    <table class="table table-bordered align-middle" id="datatableid1">
      <thead>
        <tr class="kolom">
          <th style="border-top-left-radius: 10px; border-bottom-left-radius: 10px;">Nama Produk</th>
          <th style="width: 10%;">ID Produk</th>
          <th>Kategori</th>
          <th style="width: 20%;">Supplier</th>
          <th style="width: 5%;">Stock</th>
          <th style="width: 5%;">Satuan</th>
          <th>Harga</th>
          <th style="border-top-right-radius: 10px; border-bottom-right-radius: 10px; border-right: none;">Aksi</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Modal Tambah Produk -->
  <div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addModalLabel">Tambah Produk</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
        </div>
        <div class="modal-body">
          <form id="addProdukForm">
            <div class="mb-3">
              <label for="addID" class="form-label">ID Produk (ex. PD001, max. 5 karakter)</label>
              <input type="text" class="form-control" id="addID" required />
            </div>
            <div class="mb-3">
              <label for="addNama" class="form-label">Nama Produk (max. 100 karakter)</label>
              <input type="text" class="form-control" id="addNama" required />
            </div>
            <div class="mb-3">
              <label for="addKategori" class="form-label">Kategori (max. 50 karakter)</label>
              <input type="text" class="form-control" id="addKategori" required />
            </div>
            <div class="mb-3">
              <label for="addSupplier" class="form-label">Supplier</label>
              <select id="addSupplier" class="form-select w-auto" required>
                <option value="">Pilih Supplier</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="addStok" class="form-label">Stok</label>
              <input type="number" class="form-control" id="addStok" required min="1" />
            </div>
            <div class="mb-3">
              <label for="addHarga" class="form-label">Harga (max. 10 digit depan desimal)</label>
              <input type="number" class="form-control" id="addHarga" required min="1" />
            </div>
            <button type="button" class="btn btn-primary" id="saveAddButton">Simpan Produk</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Edit Produk -->
  <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editModalLabel">Edit Produk</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
        </div>
        <div class="modal-body">
          <form id="editProdukForm">
            <div class="mb-3">
              <label for="editId" class="form-label">ID Produk (ex. PD001, max. 5 karakter)</label>
              <input type="text" class="form-control" id="editId" disabled />
            </div>
            <div class="mb-3">
              <label for="editNama" class="form-label">Nama Produk (max. 100 karakter)</label>
              <input type="text" class="form-control" id="editNama" />
            </div>
            <div class="mb-3">
              <label for="editKategori" class="form-label">Kategori (max. 50 karakter)</label>
              <input type="text" class="form-control" id="editKategori" />
            </div>
            <div class="mb-3">
              <label for="editSupplier" class="form-label">Supplier</label>
              <select id="editSupplier" class="form-select w-auto">
                <option value="">Pilih Supplier</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="editStok" class="form-label">Stok</label>
              <input type="number" class="form-control" id="editStok" />
            </div>
            <div class="mb-3">
              <label for="editHarga" class="form-label">Harga (max. 10 digit depan desimal)</label>
              <input type="number" class="form-control" id="editHarga" />
            </div>
            <button type="button" class="btn btn-primary" id="saveEditButton">Simpan Perubahan</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/2.3.0/js/dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/2.3.0/js/dataTables.bootstrap5.min.js"></script>

  <script>
        $(document).ready(function () {
      let dataTable = $('#datatableid1').DataTable({ order: [[1, 'asc']] });
      

      // Fungsi load data produk
      function loadProduk() {
        fetch('manajemen_produk.php')
          .then(res => res.json())
          .then(data => {
            dataTable.clear().draw();
            data.forEach(product => {
              dataTable.row.add([
                product.Nama_Produk,
                product.ID,
                product.Kategori,
                product.Supplier,
                product.Stock,
                'Unit',
                'Rp ' + parseFloat(product.Harga).toLocaleString('id-ID'),
                `<a class="edit icon-link" href="#" style="color: #827F7F; text-decoration: none;"><i class="fa-solid fa-pen-to-square"></i></a>
             <a class="hapus icon-link" href="#" style="color: #FA0000; text-decoration: none;" data-id="${product.ID}"><i class="fa-solid fa-trash"></i></a>`
              ]);
            });
            dataTable.draw();
          })
          .catch(error => {
            console.error('Gagal load produk:', error);
            alert('Gagal memuat data produk.');
          });
      }

      

      // Load data awal
      loadProduk();

      // Load supplier options
      function loadSupplierOptions(selectId = 'editSupplier') {
        fetch('select_supplier_mp1.php')
          .then(res => res.json())
          .then(suppliers => {
            const selectElem = document.getElementById(selectId);
            if (selectElem) {
              selectElem.innerHTML = '<option value="">Pilih Supplier</option>';
              suppliers.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.SUPPLIER_ID;
                opt.textContent = s.NAMA_SUPPLIER;
                selectElem.appendChild(opt);
              });
            }
          })
          .catch(err => console.error('Gagal load supplier:', err));
      }

      // Refresh data produk
      function refreshProduk() {
        fetch('manajemen_produk.php')
          .then(res => res.json())
          .then(data => {
            dataTable.clear().draw();
            data.forEach(product => {
              dataTable.row.add([
                product.Nama_Produk,
                product.ID,
                product.Kategori,
                product.Supplier,
                product.Stock,
                'Unit',
                'Rp ' + parseFloat(product.Harga).toLocaleString('id-ID'),
                `<a class="edit icon-link" href="#" style="color: #827F7F; text-decoration: none;"><i class="fa-solid fa-pen-to-square"></i></a>
             <a class="hapus icon-link" href="#" style="color: #FA0000; text-decoration: none;" data-id="${product.ID}"><i class="fa-solid fa-trash"></i></a>`
              ]);
            });
            dataTable.draw();
          });
      }

      // Delete semua produk
      $('.tombol1').on('click', () => {
        if (confirm('Apakah Anda yakin ingin menghapus SEMUA data produk?')) {
          fetch('delete_all_mp1.php', { method: 'POST' })
            .then(res => res.json())
            .then(res => {
              if (res.status === 'success') {
                alert('Semua data produk berhasil dihapus.');
                refreshProduk(); 
              } else {
                alert('Gagal hapus data: ' + (res.message || ''));
              }
            })
            .catch(error => {
              console.error('Error:', error);
              alert('Terjadi kesalahan saat menghapus semua produk.');
            });
        }
      });

      // Add produk
      $('.tombol2').on('click', () => {
        loadSupplierOptions('addSupplier');
        new bootstrap.Modal(document.getElementById('addModal')).show();
      });

      $('#saveAddButton').on('click', () => {
        const data = {
          nama: $('#addNama').val().trim(),
          kategori: $('#addKategori').val().trim(),
          supplier: $('#addSupplier').val(),
          stok: parseInt($('#addStok').val()),
          harga: parseInt($('#addHarga').val()),
          ID: $('#addID').val().trim()
        };
        if (!data.nama || !data.kategori || !data.supplier || !data.stok || !data.harga || !data.ID) {
          alert('Harap lengkapi semua field.');
          return;
        }
        $.post('add_data_mp1.php', data)
          .done(res => {
            if (res === 'success' || res.status === 'success') {
              alert('Produk berhasil ditambahkan!');
              $('#addModal').modal('hide');
              refreshProduk();
            } else if (res.status === 'duplicate' || res === 'duplicate') {
              alert('Gagal menambahkan: ID Produk sudah digunakan.');
            } else {
              alert('Gagal menambahkan.');
            }
          })
          .fail(() => alert('Gagal koneksi ke server/jumlah karakter atau digit melebihi yang ditetapkan.'));
      });

      // Hapus produk
      $('#datatableid1 tbody').on('click', '.hapus', function (e) {
        e.preventDefault();
        const row = $(this).closest('tr');
        const id = $(this).data('id');

        if (confirm('Apakah anda yakin ingin menghapus produk ini?')) {
          fetch('hapus_mp1.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: 'id=' + encodeURIComponent(id)
          }).then(res => res.json())
            .then(res => {
              if (res.status === 'success') {
                alert('Data berhasil dihapus.');
                refreshProduk();
              } else {
                alert('Gagal menghapus data: ' + (res.message || ''));
              }
            })
            .catch(() => alert('Terjadi kesalahan saat menghapus.'));
        }
      });

      // Edit produk
      $('#datatableid1 tbody').on('click', '.edit', function (e) {
        e.preventDefault();
        const rowData = dataTable.row($(this).parents('tr')).data();
        const id = rowData[1]; 
        fetch(`edit_mp1.php?id=${id}`)
          .then(res => res.json())
          .then(prod => {
            loadSupplierOptions('editSupplier');
            $('#editId').val(prod.PRODUK_ID);
            $('#editNama').val(prod.NAMA_PRODUK);
            $('#editKategori').val(prod.KATEGORI);
            $('#editSupplier').val(prod.SUPPLIER_ID);
            $('#editStok').val(prod.STOK);
            $('#editHarga').val(prod.HARGA_SATUAN);
            new bootstrap.Modal(document.getElementById('editModal')).show();
          })
          .catch(() => alert('Gagal memuat data produk.'));
      });

      // Save edit produk
      $('#saveEditButton').on('click', () => {
        const data = {
          id: $('#editId').val(),
          nama: $('#editNama').val(),
          kategori: $('#editKategori').val(),
          supplier: $('#editSupplier').val(),
          stok: parseInt($('#editStok').val()),
          harga: parseInt($('#editHarga').val())
        };
        fetch('edit_mp1.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams(data)
        }).then(res => res.json())
          .then(res => {
            if (res.status === 'success') {
              alert('Data berhasil diperbarui!');
              $('#editModal').modal('hide');
              refreshProduk();
            } else if (res.status === 'no_change') {
              alert('Tidak ada perubahan pada data.');
            } else {
              alert('Gagal memperbarui data.');
            }
          })
          .catch(() => alert('Terjadi kesalahan saat memperbarui.'));
      });
    });
  </script>
</body>