<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manajemen Transaksi</title>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" />

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Esteban&family=Noto+Sans:wght@400;800&display=swap"
    rel="stylesheet" />

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" />

  <!-- DataTables Bootstrap 5 CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/2.3.0/css/dataTables.bootstrap5.min.css" />

  <style>
    .nav_website {
      background-color: black;
      padding: 2%;
      margin-bottom: 5vh;
    }

    .nav_website a {
      font-family: 'Inter';
      font-weight: 600;
      font-size: 18px;
      color: white;
      padding: 8px 15px;
      border-radius: 5px;
    }

    .nav_website a:hover {
      background-color: white;
      color: black;
      transition: 0.3s;
    }

    .Judul {
      padding: 4%;
      font-family: 'Inter';
      font-weight: 600;
      font-size: 20px;
    }

    .filter_bar {
      position: relative;
    }

    .sort1 {
      padding-left: 4%;
      opacity: 0;
    }

    .sort2 {
      padding-left: 4%;
      opacity: 0;
    }

    .tombol_modif {
      position: absolute;
      right: 4%;
      top: 0;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .tombol1 {
      display: flex;
      align-items: center;
      gap: 8px;
      background-color: #db1515;
    }

    .tombol1:hover {
      background-color: #ff0000;
    }

    .tombol2 {
      display: flex;
      align-items: center;
      gap: 8px;
      background-color: #000000;
    }

    .tombol3 {
      display: flex;
      align-items: center;
      gap: 8px;
      background-color: #db1515;
    }

    .tombol3:hover {
      background-color: #ff0000;
    }

    .tombol4 {
      display: flex;
      align-items: center;
      gap: 8px;
      background-color: #000000;
    }

    .tabel1 {
      padding: 0 4%;
      margin-bottom: 20vh;
    }

    .tabel2 {
      padding: 0 4%;
      margin-bottom: 20vh;
    }

    .kolom th {
      background-color: #D9D9D9;
      border-right: 1px solid black;
      text-align: center;
    }

    tbody {
      text-align: center;
    }

    table.dataTable thead th {
      background-color: #D9D9D9 !important;
      color: black;
      vertical-align: middle;
    }

    table.dataTable thead th.sorting::after,
    table.dataTable thead th.sorting_asc::after,
    table.dataTable thead th.sorting_desc::after {
      color: black !important;
      opacity: 1 !important;
    }

    table.dataTable thead th.sorting::after {
      content: "\f0dc";
      font-family: "Font Awesome 6 Free";
      font-weight: 900;
    }

    table.dataTable thead th.sorting_asc::after {
      content: "\f0de";
      font-family: "Font Awesome 6 Free";
      font-weight: 900;
    }

    table.dataTable thead th.sorting_desc::after {
      content: "\f0dd";
      font-family: "Font Awesome 6 Free";
      font-weight: 900;
    }

  </style>
</head>

<body>

  <!-- Modifikasi Produk -->

  <!-- Navigation -->
  <nav class="nav_website">
    <ul class="nav nav-pills nav-fill">
      <li class="nav-item"><a class="nav-link" href="proteksiDashboard.php">Dashboard</a></li>
      <li class="nav-item"><a class="nav-link" href="proteksiMP.php">Manajemen Produk</a></li>
      <li class="nav-item"><a class="nav-link" href="proteksiMT.php">Manajemen Transaksi</a></li>
      <li class="nav-item"><a class="nav-link" href="proteksiLaporan.php">Laporan</a></li>
      <li class="nav-item"><a class="nav-link" href="#" id="logoutBtn">Log Out</a></li>
    </ul>
  </nav>

  <!-- Judul -->
  <section class="Judul">
    <p>Manajemen Penjualan <br> (Sales Management)</p>
  </section>

  <!-- Filter Bar -->
  <section class="filter_bar">
    <div class="d-flex justify-content-between align-items-start mb-3">
      <div class="sort1">
        <select class="form-select" id="sortAll" style="width: auto;" disabled>
          <option value="">All</option>
          <option value="<10">Kurang dari 10</option>
          <option value="11-50">11-50</option>
          <option value="51-100">51-100</option>
          <option value=">100">Lebih dari 100</option>
        </select>
      </div>
      <div class="tombol_modif">
        <button class="tombol1 btn btn-dark"><span>Delete All</span><i class="fa-solid fa-trash"></i></button>
        <button class="tombol2 btn btn-dark"><span>Add Data</span><i class="fa-solid fa-square-plus"></i></button>
      </div>
    </div>
  </section>

  <!-- Tabel Penjualan -->
  <section class="tabel1">
    <table class="table table-bordered align-middle" id="datatableid1">
      <thead>
        <tr class="kolom">
          <th style="border-top-left-radius: 10px; border-bottom-left-radius: 10px;">Tanggal</th>
          <th style="width: 10%">ID Penjualan/Nota</th>
          <th style="width: 10%;">ID Detail Penjualan</th>
          <th>Nama Produk</th>
          <th style="width: 5%;">Jumlah</th>
          <th style="width: 10%;">Harga Jual</th>
          <th>Total</th>
          <th style="border-top-right-radius: 10px; border-bottom-right-radius: 10px; border-right: none;">Aksi</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Modal Tambah Penjualan -->
  <div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addModalLabel">Tambah Penjualan</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
        </div>
        <div class="modal-body">
          <form id="addProdukForm">
            <div class="mb-3">
              <label for="addTanggal" class="form-label">Tanggal </label>
              <input type="date" class="form-control" id="addTanggal" required />
            </div>
            <div class="mb-3">
              <label for="addIDP" class="form-label">ID Penjualan/Nota (ex. SL001, max. 5 karakter)</label>
              <input type="text" class="form-control" id="addIDP" required />
            </div>
            <div class="mb-3">
              <label for="addID" class="form-label">ID Detail Penjualan (ex. DS001, max. 5 karakter)</label>
              <input type="text" class="form-control" id="addID" required />
            </div>
            <div class="mb-3">
              <label for="addProduk" class="form-label">Produk</label>
              <select id="addProduk" class="form-select w-auto">
                <option value="">Pilih Produk</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="addJumlah" class="form-label">Jumlah</label>
              <input type="number" class="form-control" id="addJumlah" required min="1" />
            </div>
            <button type="button" class="btn btn-primary" id="saveAddButton">Simpan Penjualan</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Edit Penjualan -->
  <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editModalLabel">Edit Penjualan</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
        </div>
        <div class="modal-body">
          <form id="editProdukForm">
            <div class="mb-3">
              <label for="editTanggal" class="form-label">Tanggal </label>
              <input type="date" class="form-control" id="editTanggal" />
            </div>
            <div class="mb-3">
              <label for="editIDP" class="form-label">ID Penjualan/Nota (ex. SL001, max. 5 karakter)</label>
              <input type="text" class="form-control" id="editIDP" required disabled/>
            </div>
            <div class="mb-3">
              <label for="editID" class="form-label">ID Detail Penjualan (ex. DS001, max. 5 karakter)</label>
              <input type="text" class="form-control" id="editID" disabled />
            </div>
            <div class="mb-3">
              <label for="editProduk" class="form-label">Produk</label>
              <select id="editProduk" class="form-select w-auto">
                <option value="">Pilih Produk</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="editJumlah" class="form-label">Jumlah</label>
              <input type="number" class="form-control" id="editJumlah" required min="1" />
            </div>
            <button type="button" class="btn btn-primary" id="saveEditButton">Simpan Perubahan</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Manajemen Pembelian -->

  <!-- Judul -->
  <section class="Judul">
    <p>Manajemen Pembelian <br> (Purchasing Management)</p>
  </section>

  <!-- Filter Bar -->
  <section class="filter_bar">
    <div class="d-flex justify-content-between align-items-start mb-3">
      <div class="sort2">
        <select class="form-select" id="sortAll" style="width: auto;" disabled>
          <option value="">All</option>
          <option value="<10">Kurang dari 10</option>
          <option value="11-50">11-50</option>
          <option value="51-100">51-100</option>
          <option value=">100">Lebih dari 100</option>
        </select>
      </div>
      <div class="tombol_modif">
        <button class="tombol3 btn btn-dark"><span>Delete All</span><i class="fa-solid fa-trash"></i></button>
        <button class="tombol4 btn btn-dark"><span>Add Data</span><i class="fa-solid fa-square-plus"></i></button>
      </div>
    </div>
  </section>

  <!-- Tabel Pembelian -->
  <section class="tabel2">
    <table class="table table-bordered align-middle" id="datatableid2">
      <thead>
        <tr class="kolom">
          <th style="border-top-left-radius: 10px; border-bottom-left-radius: 10px; width: 10%;">Tanggal</th>
          <th style="width: 5%">ID Pembelian/Nota</th>
          <th style="width: 5%;">ID Detail Pembelian</th>
          <th>Supplier</th>
          <th style="width: 17%;">Nama Produk</th>
          <th style="width: 5%;">Jumlah</th>
          <th style="width: 10%;">Harga Beli</th>
          <th style="width: 12%;">Total</th>
          <th style="border-top-right-radius: 10px; border-bottom-right-radius: 10px; border-right: none; width: 5%;">
            Aksi</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Modal Tambah Pembelian -->
  <div class="modal fade" id="addModal2" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addModalLabel2">Tambah Pembelian</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
        </div>
        <div class="modal-body">
          <form id="addSupplierForm">
            <div class="mb-3">
              <label for="addTanggal2" class="form-label">Tanggal</label>
              <input type="date" class="form-control" id="addTanggal2" required />
            </div>
            <div class="mb-3">
              <label for="addIDP2" class="form-label">ID Pembelian/Nota (ex. BU001, max. 5 karakter)</label>
              <input type="text" class="form-control" id="addIDP2" required />
            </div>
            <div class="mb-3">
              <label for="addID2" class="form-label">ID Detail Pembelian (ex. DB001, max. 5 karakter)</label>
              <input type="text" class="form-control" id="addID2" required />
            </div>
            <div class="mb-3">
              <label for="addProduk2" class="form-label">Produk</label>
              <select id="addProduk2" class="form-select w-auto">
                <option value="">Pilih Produk</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="addSupplier2" class="form-label">Supplier</label>
              <select id="addSupplier2" class="form-select w-auto">
                <option value="">Pilih Supplier</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="addJumlah2" class="form-label">Jumlah (min. 10)</label>
              <input type="number" class="form-control" id="addJumlah2" required min="10" />
            </div>
            <button type="button" class="btn btn-primary" id="saveAddButton2">Simpan Pembelian</button>
          </form>
        </div>
      </div>
    </div>
  </div>


  <!-- Modal Edit Pembelian -->
  <div class="modal fade" id="editModal2" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editModalLabel2">Edit Pembelian</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
        </div>
        <div class="modal-body">
          <form id="editSupplierForm">
            <div class="mb-3">
              <label for="editTanggal2" class="form-label">Tanggal</label>
              <input type="date" class="form-control" id="editTanggal2" required />
            </div>
            <div class="mb-3">
              <label for="editIDP2" class="form-label">ID Pembelian/Nota (ex. BU001, max. 5 karakter)</label>
              <input type="text" class="form-control" id="editIDP2" required disabled />
            </div>
            <div class="mb-3">
              <label for="editID2" class="form-label">ID Detail Pembelian (ex. DB001, max. 5 karakter)</label>
              <input type="text" class="form-control" id="editID2" required disabled />
            </div>
            <div class="mb-3">
              <label for="editProduk2" class="form-label">Produk</label>
              <select id="editProduk2" class="form-select w-auto">
                <option value="">Pilih Produk</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="editSupplier2" class="form-label">Supplier</label>
              <select id="editSupplier2" class="form-select w-auto">
                <option value="">Pilih Supplier</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="editJumlah2" class="form-label">Jumlah (min. 10)</label>
              <input type="number" class="form-control" id="editJumlah2" required min="1" />
            </div>
            <button type="button" class="btn btn-primary" id="saveEditButton2">Simpan Perubahan</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/2.3.0/js/dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/2.3.0/js/dataTables.bootstrap5.min.js"></script>

  <script>

    // Mekanisme Log Out
    document.getElementById("logoutBtn").addEventListener("click", function (e) {
      e.preventDefault();
      const confirmLogout = confirm("Apakah Anda yakin ingin logout?");
      if (confirmLogout) {
        window.location.href = "logout.php?message=logout";
      }
    });

    window.addEventListener('pageshow', function (event) {
      if (event.persisted) {
        window.location.reload();
      }
    });

    $(document).ready(function () {
      let dataTable = $('#datatableid1').DataTable();
      let dataTable2 = $('#datatableid2').DataTable();

      // Fungsi load data transaksi
      function loadTransaksi() {
        fetch('manajemen_transaksi.php')
          .then(res => res.json())
          .then(data => {
            dataTable.clear().draw();
            data.forEach(dp => {
              let tombolEdit;
              console.log(dp);
              if (dp.Bisa_Edit == 1) {
                tombolEdit = `<a class="edit icon-link" href="#" style="color: #827F7F; text-decoration: none;"><i class="fa-solid fa-pen-to-square"></i></a>`;
              } else {
                tombolEdit = `<a class="edit icon-link" href="#" style="color: #FF0000; text-decoration: none; cursor: not-allowed; pointer-events: none; opacity: 0.5;" title="Produk sudah dihapus dan tidak bisa diedit">
                            <i class="fa-solid fa-ban"></i>
                          </a>`;
              }

              dataTable.row.add([
                dp.Tanggal,
                dp.IDP,
                dp.ID,
                dp.Nama_Produk,
                dp.Jumlah,
                'Rp ' + parseFloat(dp.Harga).toLocaleString('id-ID'),
                'Rp ' + parseFloat(dp.Total).toLocaleString('id-ID'),
                `${tombolEdit}
             <a class="hapus icon-link" href="#" style="color: #FA0000; text-decoration: none;" data-id="${dp.ID}"><i class="fa-solid fa-trash"></i></a>`
              ])
            });
            dataTable.draw();
          })
          .catch(error => {
            console.error('Gagal load penjualan:', error);
            alert('Gagal memuat data penjualan.');
          });
      }

      function loadTransaksi2() {
        fetch('manajemen_transaksi2.php')
          .then(res => res.json())
          .then(data => {
            dataTable2.clear().draw();
            data.forEach(db => {
              let tombolEdit;
              console.log(db);
              if (db.Bisa_Edit == 1) {
                tombolEdit = `<a class="edit2 icon-link" href="#" style="color: #827F7F; text-decoration: none;"><i class="fa-solid fa-pen-to-square"></i></a>`;
              } else {
                tombolEdit = `<a class="edit2 icon-link" href="#" style="color: #FF0000; text-decoration: none; cursor: not-allowed; pointer-events: none; opacity: 0.5;" title="Produk sudah dihapus dan tidak bisa diedit">
                            <i class="fa-solid fa-ban"></i>
                          </a>`;
              }
              dataTable2.row.add([
                db.Tanggal2,
                db.IDP2,
                db.ID2,
                db.Supplier2,
                db.Produk2,
                db.Jumlah2,
                'Rp ' + parseFloat(db.Harga2).toLocaleString('id-ID'),
                'Rp ' + parseFloat(db.Total2).toLocaleString('id-ID'),
                `${tombolEdit}
             <a class="hapus2 icon-link" href="#" style="color: #FA0000; text-decoration: none;" data-id="${db.ID2}"><i class="fa-solid fa-trash"></i></a>`
              ])
            });
            dataTable2.draw();
          })
          .catch(error => {
            console.error('Gagal load pembelian:', error);
            alert('Gagal memuat data pembelian.');
          });
      }

      loadTransaksi();
      loadTransaksi2();

      // Load produk options
      function loadProdukOptions(selectIds = ['editProduk']) {
        fetch('select_produk_mt1.php')
          .then(res => res.json())
          .then(product => {
            if (!Array.isArray(selectIds)) {
              selectIds = [selectIds];
            }

            selectIds.forEach(selectId => {
              const selectElem = document.getElementById(selectId);
              if (selectElem) {
                selectElem.innerHTML = '<option value="">Pilih Produk</option>';
                product.forEach(p => {
                  const opt = document.createElement('option');
                  opt.value = p.PRODUK_ID;
                  opt.textContent = p.NAMA_PRODUK;  
                  selectElem.appendChild(opt);
                });
              }
            });
          })
          .catch(err => console.error('Gagal load produk:', err));
      }

      function loadProdukOptions2(selectIds = ['editProduk2']) {
        fetch('select_produk_mt2.php')
          .then(res => res.json())
          .then(product => {
            if (!Array.isArray(selectIds)) {
              selectIds = [selectIds];
            }

            selectIds.forEach(selectId => {
              const selectElem = document.getElementById(selectId);
              if (selectElem) {
                selectElem.innerHTML = '<option value="">Pilih Produk</option>';
                product.forEach(p => {
                  const opt = document.createElement('option');
                  opt.value = p.PRODUK_ID;
                  opt.textContent = p.NAMA_PRODUK;  
                  selectElem.appendChild(opt);
                });
              }
            });
          })
          .catch(err => console.error('Gagal load produk:', err));
      }

      

      function loadSupplierByProduk(selectId, produkId, selectedSupplierId = '') {
        if (!produkId) {
          document.getElementById(selectId).innerHTML = '<option value="">Pilih Supplier</option>';
          return;
        }

        fetch(`select_supplier_mt2.php?produk_id=${produkId}`)
          .then(res => res.json())
          .then(suppliers => {
            const selectElem = document.getElementById(selectId);
            selectElem.innerHTML = '<option value="">Pilih Supplier</option>';
            suppliers.forEach(s => {
              const opt = document.createElement('option');
              opt.value = s.SUPPLIER_ID;
              opt.textContent = s.NAMA_SUPPLIER;
              if (s.SUPPLIER_ID === selectedSupplierId) {
                opt.selected = true;
              }
              selectElem.appendChild(opt);
            });
          })
          .catch(err => console.error('Gagal load supplier:', err));
      }

      loadProdukOptions2();

      // Refresh data penjualan
      function refreshTransaksi() {
        fetch('manajemen_transaksi.php')
          .then(res => res.json())
          .then(data => {
            dataTable.clear().draw();
            data.forEach(dp => {
              let tombolEdit;
              console.log(dp);
              if (dp.Bisa_Edit == 1) {
                tombolEdit = `<a class="edit icon-link" href="#" style="color: #827F7F; text-decoration: none;"><i class="fa-solid fa-pen-to-square"></i></a>`;
              } else {
                tombolEdit = `<a class="edit icon-link" href="#" style="color: #FF0000; text-decoration: none; cursor: not-allowed; pointer-events: none; opacity: 0.5;" title="Produk sudah dihapus dan tidak bisa diedit">
                            <i class="fa-solid fa-ban"></i>
                          </a>`;
              }

              dataTable.row.add([
                dp.Tanggal,
                dp.IDP,
                dp.ID,
                dp.Nama_Produk,
                dp.Jumlah,
                'Rp ' + parseFloat(dp.Harga).toLocaleString('id-ID'),
                'Rp ' + parseFloat(dp.Total).toLocaleString('id-ID'),
                `${tombolEdit}
             <a class="hapus icon-link" href="#" style="color: #FA0000; text-decoration: none;" data-id="${dp.ID}"><i class="fa-solid fa-trash"></i></a>`
              ])
            });
            dataTable.draw();
          })
      }



      // Refresh data pembelian
      function refreshTransaksi2() {
        fetch('manajemen_transaksi2.php')
          .then(res => res.json())
          .then(data => {
            dataTable2.clear().draw();
            data.forEach(db => {
              let tombolEdit;
              console.log(db);
              if (db.Bisa_Edit == 1) {
                tombolEdit = `<a class="edit2 icon-link" href="#" style="color: #827F7F; text-decoration: none;"><i class="fa-solid fa-pen-to-square"></i></a>`;
              } else {
                tombolEdit = `<a class="edit2 icon-link" href="#" style="color: #FF0000; text-decoration: none; cursor: not-allowed; pointer-events: none; opacity: 0.5;" title="Produk sudah dihapus dan tidak bisa diedit">
                            <i class="fa-solid fa-ban"></i>
                          </a>`;
              }
              dataTable2.row.add([
                db.Tanggal2,
                db.IDP2,
                db.ID2,
                db.Supplier2,
                db.Produk2,
                db.Jumlah2,
                'Rp ' + parseFloat(db.Harga2).toLocaleString('id-ID'),
                'Rp ' + parseFloat(db.Total2).toLocaleString('id-ID'),
                `${tombolEdit}
             <a class="hapus2 icon-link" href="#" style="color: #FA0000; text-decoration: none;" data-id="${db.ID2}"><i class="fa-solid fa-trash"></i></a>`
              ])
            });
            dataTable2.draw();
          })
      }

      // Delete semua penjualan
      $('.tombol1').on('click', () => {
        if (confirm('Apakah Anda yakin ingin menghapus SEMUA data penjualan?')) {
          fetch('delete_all_mt1.php', { method: 'POST' })
            .then(res => res.json())
            .then(res => {
              if (res.status === 'success') {
                alert('Semua data detail penjualan berhasil dihapus.');
                refreshTransaksi(); 
              } else {
                alert('Gagal hapus data: ' + (res.message || ''));
              }
            })
            .catch(error => {
              console.error('Error:', error);
              alert('Terjadi kesalahan saat menghapus semua produk.');
            });
        }
      });

      // Delete semua pembelian
      $('.tombol3').on('click', () => {
        if (confirm('Apakah Anda yakin ingin menghapus SEMUA data pembelian?')) {
          fetch('delete_all_mt2.php', { method: 'POST' })
            .then(res => res.json())
            .then(res => {
              if (res.status === 'success') {
                alert('Semua data pembelian berhasil dihapus.');
                refreshTransaksi2();
              } else {
                alert('Gagal hapus data: ' + (res.message || ''));
              }
            })
            .catch(error => {
              console.error('Error:', error);
              alert('Terjadi kesalahan saat menghapus semua pembelian.');
            });
        }
      });

      // Add Penjualan
      $('.tombol2').on('click', () => {
        loadProdukOptions('addProduk');
        new bootstrap.Modal(document.getElementById('addModal')).show();
      });

      $('#saveAddButton').on('click', () => {
        const data = {
          Tanggal: $('#addTanggal').val().trim(),
          IDP: $('#addIDP').val().trim(),
          ID: $('#addID').val().trim(),
          Nama_Produk: $('#addProduk').val(),
          Jumlah: parseInt($('#addJumlah').val())
        };

        if (isNaN(data.Jumlah) || data.Jumlah <= 0) {
          alert('Jumlah harus berupa angka positif.');
          return;
        }

        if (!data.Tanggal || !data.IDP || !data.ID || !data.Nama_Produk || !data.Jumlah) {
          alert('Harap lengkapi semua field.');
          return;
        }
        $.post('add_data_mt1.php', data)
          .done(res => {
            if (res === 'success' || res.status === 'success') {
              alert('Penjualan berhasil ditambahkan!');
              $('#addModal').modal('hide');
              refreshTransaksi();
            } else if (res === 'duplicate' || res.status === 'duplicate') {
              alert('Gagal menambahkan: ID Detail Penjualan sudah digunakan.');
            } else {
              alert('Gagal menambahkan/jumlah karakter atau digit melebihi yang ditetapkan.');
            }
          })
          .fail(() => alert('Gagal koneksi ke server/jumlah karakter atau digit melebihi yang ditetapkan.'));
      });

      // Add pembelian
      $('.tombol4').on('click', () => {
        loadProdukOptions2('addProduk2');
        $('#addProduk2').off('change');
        $('#addProduk2').on('change', () => {
          const produkId = $('#addProduk2').val();
          loadSupplierByProduk('addSupplier2', produkId);
        });
        new bootstrap.Modal(document.getElementById('addModal2')).show();
      });

      $('#saveAddButton2').on('click', () => {
        const data = {
          Tanggal2: $('#addTanggal2').val().trim(),
          IDP2: $('#addIDP2').val().trim(),
          ID2: $('#addID2').val().trim(),
          Supplier2: $('#addSupplier2').val().trim(),
          Produk2: $('#addProduk2').val().trim(),
          Jumlah2: parseInt($('#addJumlah2').val())
        };

        if (!data.Tanggal2 || !data.IDP2 || !data.ID2 || !data.Supplier2 || !data.Produk2 || !data.Jumlah2) {
          alert('Harap lengkapi semua field.');
          return;
        }
        $.post('add_data_mt2.php', data)
          .done(res => {
            if (res === 'success' || res.status === 'success') {
              alert('Pembelian berhasil ditambahkan!');
              $('#addModal2').modal('hide');
              refreshTransaksi2();
            } else if (res === 'duplicate' || res.status === 'duplicate') {
              alert('Gagal menambahkan: ID Detail Pembelian sudah digunakan.');
            } else if (res === 'error' || res.status === 'error') {
              alert('Tidak bisa menambahkan detail ke ID Pembelian ini karena supplier berbeda.');
            } else {
              alert('Gagal menambahkan/jumlah karakter atau digit melebihi yang ditetapkan.');
            }
          })
          .fail(() => alert('Gagal koneksi ke server/jumlah karakter atau digit tidak sesuai dengan yang ditetapkan.'));
      });

      // Hapus Penjualan
      $('#datatableid1 tbody').on('click', '.hapus', function (e) {
        e.preventDefault();
        const id = $(this).data('id');
        if (confirm('Apakah anda yakin ingin menghapus produk ini?')) {
          fetch('hapus_mt1.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: 'id=' + encodeURIComponent(id)
          }).then(res => res.json())
            .then(res => {
              if (res.status === 'success') {
                alert('Data berhasil dihapus.');
                refreshTransaksi();
              } else {
                alert('Gagal menghapus data: ' + (res.message || ''));
              }
            })
            .catch(() => alert('Terjadi kesalahan saat menghapus.'));
        }
      });

      // Hapus Pembelian
      $('#datatableid2 tbody').on('click', '.hapus2', function (e) {
        e.preventDefault();
        const id = $(this).data('id');
        if (confirm('Apakah anda yakin ingin menghapus pembelian ini?')) {
          fetch('hapus_mt2.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: 'id=' + encodeURIComponent(id)
          }).then(res => res.json())
            .then(res => {
              if (res.status === 'success') {
                alert('Data berhasil dihapus.');
                refreshTransaksi2();
              } else {
                alert('Gagal menghapus data: ' + (res.message || ''));
              }
            })
            .catch(() => alert('Terjadi kesalahan saat menghapus.'));
        }
      });

      // Edit Transaksi
      $('#datatableid1 tbody').on('click', '.edit', function (e) {
        e.preventDefault();
        const rowData = dataTable.row($(this).parents('tr')).data();
        const id = rowData[2];
        fetch(`edit_mt1.php?id=${id}`)
          .then(res => res.json())
          .then(dp => {
            console.log(dp);
            loadProdukOptions('editProduk');
            $('#editTanggal').val(dp.TANGGAL);
            $('#editIDP').val(dp.PENJUALAN_ID);
            $('#editID').val(dp.DETAIL_ID);
            $('#editProduk').val(dp.PRODUK_ID);
            $('#editJumlah').val(dp.JUMLAH);
            new bootstrap.Modal(document.getElementById('editModal')).show();
          })
          .catch(() => alert('Gagal memuat data penjualan.'));
      });

      $('#datatableid2 tbody').on('click', '.edit2', function (e) {
        e.preventDefault();
        const rowData = dataTable2.row($(this).parents('tr')).data();
        const id = rowData[2]; 
        fetch(`edit_mt2.php?id=${id}`)
          .then(res => res.json())
          .then(db => {
            $('#editTanggal2').val(db.TANGGAL);
            $('#editIDP2').val(db.PEMBELIAN_ID);
            $('#editID2').val(db.DETAIL_PEMBELIAN_ID);
            $('#editSupplier2').val(db.SUPPLIER_ID);
            $('#editProduk2').val(db.PRODUK_ID);
            $('#editJumlah2').val(db.JUMLAH);
            loadProdukOptions2('editProduk2') 
            loadSupplierByProduk('editSupplier2', db.PRODUK_ID, db.SUPPLIER_ID); 
            $('#editProduk2').on('change', () => {
              const produkId = $('#editProduk2').val();
              loadSupplierByProduk('editSupplier2', produkId);
            });
            new bootstrap.Modal(document.getElementById('editModal2')).show();
          })
          .catch(() => alert('Gagal memuat data pembelian.'));
      });

      // Save edit transaksi
      $('#saveEditButton').on('click', () => {
        const data = {
          Tanggal: $('#editTanggal').val(),
          IDP: $('#editIDP').val(),
          ID: $('#editID').val(),
          Nama_Produk: $('#editProduk').val(),
          Jumlah: parseInt($('#editJumlah').val())
        };

        if (!data.Tanggal || !data.IDP || !data.ID || !data.Nama_Produk || isNaN(data.Jumlah) || data.Jumlah <= 0) {
          alert('Harap lengkapi semua field dengan benar.');
          return;
        }

        fetch('edit_mt1.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams(data)
        }).then(res => res.json())
          .then(res => {
            if (res.status === 'success') {
              alert('Data berhasil diperbarui!');
              $('#editModal').modal('hide');
              refreshTransaksi();
            } else if (res.status === 'no_change') {
              alert('Tidak ada perubahan pada data.');
            } else {
              alert('Gagal memperbarui data/jumlah karakter atau digit melebihi yang ditentukan/Field ada yang tidak terisi.');
            }
          })
          .catch(() => alert('Terjadi kesalahan saat memperbarui/jumlah karakter atau digit melebihi yang ditetapkan.' + error.message));
      });

      $('#saveEditButton2').on('click', () => {
        const data = {
          Tanggal2: $('#editTanggal2').val().trim(),
          IDP2: $('#editIDP2').val().trim(),
          ID2: $('#editID2').val().trim(),
          Supplier2: $('#editSupplier2').val().trim(), 
          Produk2: $('#editProduk2').val().trim(),
          Jumlah2: parseInt($('#editJumlah2').val())
        };

        if (!data.Tanggal2 || !data.IDP2 || !data.ID2 || !data.Supplier2 || !data.Produk2 || isNaN(data.Jumlah2) || data.Jumlah2 <= 0) {
          alert('Harap lengkapi semua field dengan benar.');
          return;
        }

        fetch('edit_mt2.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams(data)
        })
          .then(res => res.json())
          .then(res => {
            if (res.status === 'success') {
              alert('Data berhasil diperbarui!');
              $('#editModal2').modal('hide');
              refreshTransaksi2();
            } else if (res.status === 'nochange' || res.status === 'no_change') {
              alert('Tidak ada perubahan pada data.');
            } else if (res.message) {
              alert('Gagal memperbarui: ' + res.message);
            } else {
              alert('Gagal memperbarui data/jumlah karakter atau digit melebihi yang ditetapkan.');
            }
          })
          .catch(() => {
            alert('Terjadi kesalahan saat memperbarui. Pastikan koneksi stabil dan data tidak melebihi batas.' + error.message);
          });
      });
    });
  </script>
</body>

</html>